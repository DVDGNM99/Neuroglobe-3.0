# NeuroGlobe Antigravity

**NeuroGlobe Antigravity** is a comprehensive toolkit for mining, analyzing, and visualizing mouse brain connectivity data using the Allen Brain Atlas API. It provides a pipeline to fetch experimental data, perform statistical analysis, and render 3D interactive scenes with tractography.

---

## üìö Table of Contents
- [Project Structure](#project-structure)
- [Environments & Setup](#environments--setup)
- [Configuration](#configuration)
- [Mining Pipeline](#mining-pipeline)
- [Analysis](#analysis)
- [Viewer & Visualization](#viewer--visualization)
- [Testing](#testing)

---

## üìÇ Project Structure

```
neuroglobe-antigravity/
‚îú‚îÄ‚îÄ analysis/               # Jupyter notebooks for statistical analysis
‚îú‚îÄ‚îÄ configs/                # Configuration files (YAML/JSON)
‚îú‚îÄ‚îÄ data/                   # Data storage (Raw & Processed)
‚îú‚îÄ‚îÄ envs/                   # Conda environment definitions
‚îú‚îÄ‚îÄ scenes/                 # Saved 3D scenes and screenshots
‚îú‚îÄ‚îÄ src/                    # Source code
‚îÇ   ‚îú‚îÄ‚îÄ miner/              # Data mining scripts
‚îÇ   ‚îî‚îÄ‚îÄ viewer/             # Visualization scripts
‚îú‚îÄ‚îÄ tests/                  # Test suite
‚îî‚îÄ‚îÄ README.md               # This guide
```

---

## üõ† Environments & Setup

This project uses **Conda** to manage dependencies. There are two main environments:

### 1. `allensdk` (Mining & Analysis)
Used for fetching data from the Allen API and running analysis.
- **File**: `envs/allensdk.yml`
- **Key Packages**: `allensdk`, `pandas`, `jupyter`, `scipy`

**Activation**:
```bash
conda env create -f envs/allensdk.yml
conda activate allensdk
```

### 2. `brainglobe_render` (Viewer)
Used for 3D rendering with BrainGlobe and Vedo.
- **File**: `envs/brainglobe_render.yml`
- **Key Packages**: `brainglobe`, `brainrender`, `vedo`, `dearpygui`

**Activation**:
```bash
conda env create -f envs/brainglobe_render.yml
conda activate brainglobe_render
```

---

## ‚öôÔ∏è Configuration

### `configs/mining_config.yaml`
Controls the mining process.
- **`experiment.seed_acronym`**: The brain region to use as the injection seed (e.g., `VISp`).
- **`selection.custom_targets`**: List of target regions to filter or analyze.

### `configs/regions.json`
Controls the Viewer's default region list.
- Contains a list of regions with `acronym`, `name`, and `color_hex_triplet`.

---

## ‚õè Mining Pipeline

Scripts located in `src/miner/`. Run these in the **`allensdk`** environment.

### 1. `fetch.py`
**Function**: Queries the Allen API for experiments injected in the seed region defined in `mining_config.yaml`.
**Output**: Prints a summary of found experiments.

### 2. `extract_tracts.py`
**Function**: Downloads the projection density volume (tractography) for a specific experiment ID.
**Usage**: Can be imported or run to test extraction for the first found experiment.
**Output**: Saves `.nrrd` files to `data/processed/tracts/`.

### 3. `miner_analysis.py`
**Function**: Performs a full analysis of projection data.
- Fetches "unionize" data (projection stats per region).
- Enriches data with ontology (names, acronyms).
- Calculates lateralization (Ipsilateral/Contralateral).
**Output**: Saves a CSV file to `analysis/data/` (e.g., `VISp_full_analysis.csv`).

---

## üìä Analysis

Located in `analysis/`. Run in the **`allensdk`** environment.

### `analisi_proiezioni_stat.ipynb`
**Function**: Interactive Jupyter Notebook for statistical analysis.
- Loads the CSV generated by `miner_analysis.py`.
- Generates plots (Connectivity Matrix, Bar Charts).
- Performs statistical tests (e.g., Coefficient of Variation).
- Exports filtered data for the Viewer.

---

## üõ† Data Preparation (Native Workflow)
The viewer expects data to be registered to the Allen Mouse Brain Atlas (CCFv3 25um).
However, raw data often has incorrect metadata (e.g., spacing=1 instead of 25).

We provide tools to fix this automatically:

1.  **Check your data**:
    ```bash
    python scripts/check_volume_info.py data/processed/tracts/your_file.nrrd
    ```
2.  **Fix metadata**:
    ```bash
    python scripts/fix_volume_metadata.py data/processed/tracts/your_file.nrrd
    ```
    This will create a `_fixed.vtk` file (Mesh) with correct spacing (25um) and origin (0,0,0).
    The viewer will **automatically** prioritize this file if it exists.

## Manual Fine-Tuning
Even with correct metadata, slight misalignments can occur due to different registration templates.
You can manually fine-tune the alignment in `src/viewer/rendering.py` by editing the constants at the top of the file:

```python
# Manual Shifts (Microns)
SHIFT_X = 0    # + Right, - Left
SHIFT_Y = 0    # + Down (Ventral), - Up (Dorsal)
SHIFT_Z = 0    # + Back (Caudal), - Front (Rostral)

# Manual Rotations (Degrees)
ROTATE_X = 0
ROTATE_Y = 90  # Often needed for A-P orientation
ROTATE_Z = 0
```
For new experimental data not yet registered to the Allen Atlas, use **[brainreg](https://github.com/brainglobe/brainreg)**:
```bash
brainreg /path/to/raw_data /path/to/output_dir -v 25 -a allen_mouse_25um
```

---

## üñ• Viewer & Visualization

Scripts located in `src/viewer/`. Run these in the **`brainglobe_render`** environment.

### 3. Interactive 3D Viewer
  - Visualize brain regions and projection clouds.
  - Toggle visibility and transparency.
  - *Coming Soon: Click-to-select regions for detailed stats.*
Launch the viewer to explore the data in 3D:
```bash
python src/viewer/main.py
```
### Visualization Features
- **Brain Regions**: Render any brain region by acronym with custom colors.
- **Tractography**:
    - **Density (Raw)**: Full projection density cloud.
    - **Density (Filtered)**: Masked cloud showing only connections to selected regions.
    - **Streamlines**: (Experimental) Tube visualization.
- **GUI Controls**:
    - **Top Bar**: Dropdowns for Manual Actions (Add Region/Group) and Data Loading (Auto-detects CSVs).
    - **Bottom Bar**: Large "RENDER SCENE" button and Visualization Mode selector.
- **Interactivity**:
    - **Navigation**: Rotate, Pan, Zoom.
    - **Views**: Quick views (X/Y/Z keys).
    - **Style**: Toggle wireframe (K key - Experimental).
-   **`rendering.py`**: The rendering core.
    -   **Fixed Pivot Rotation**: Rotations now occur around the Raw Cloud's center to ensure Raw and Filtered data stay aligned.
    -   **Viridis Colormap**: Uses the standard scientific colormap (Purple=Low, Yellow=High).
    -   **Legend**: Displays a scalar bar with value ranges.
    -   **Controls**:
        -   `X`, `Y`, `Z`: Snap to Side, Front, Top views (Double-tap).
        -   `S`: Save screenshot (transparent PNG) + metadata.
-   **`filter_tracts.py`**: High-performance voxel masking script.

---

## üß™ Testing

The project includes a comprehensive test suite in `tests/`.

**Prerequisites**:
```bash
pip install pytest
```

**Running Tests**:
```bash
pytest
```

**Test Coverage**:
- **`tests/miner/`**: Verifies API fetching and data logic.
- **`tests/viewer/`**: Tests UI logic and rendering engine (via mocks).
- **`tests/analysis/`**: Validates notebook structure.
- **`tests/environments/`**: Checks environment configuration files.